<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙŠØ¯Ù„Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ - V15</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #00695c; --bg: #e0f2f1; --accent: #00897b; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); margin: 0; padding: 5px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 15px; border-radius: 10px; min-height: 90vh; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #b2dfdb; padding: 5px; border-radius: 8px; }
        .nav-item { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; border-radius: 6px; transition: 0.2s; color: #004d40; }
        .nav-item.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section.active { display: block; }

        .form-group { margin-bottom: 18px; position: relative; }
        label { display: block; font-weight: bold; margin-bottom: 6px; color: #444; }
        input, select { width: 100%; padding: 14px; border: 2px solid #b2dfdb; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        input:focus, select:focus { border-color: var(--primary); outline: none; background: white; }
        select:disabled { background: #eee; color: #aaa; }

        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; margin-top: 8px; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-import { background-color: var(--primary); }
        .btn-save { background-color: #2e7d32; }
        .btn-backup { background-color: #f57c00; }
        .btn-reset { background-color: #c62828; margin-top: 25px; font-size: 14px; opacity: 0.8; }
        
        .debug-console { background: #263238; color: #80cbc4; padding: 12px; height: 100px; overflow-y: auto; font-size: 12px; margin-top: 20px; direction: ltr; text-align: left; border-radius: 6px; font-family: monospace; }
        .balance-box { padding: 20px; background: #e8f5e9; border: 1px solid #c8e6c9; text-align: center; display: none; border-radius: 8px; margin-bottom: 15px; }
        .balance-num { font-size: 2em; font-weight: bold; color: #2e7d32; display: block; }

        .suggestions-list { border: 1px solid #ddd; max-height: 220px; overflow-y: auto; display: none; position: absolute; background: white; width: 100%; z-index: 100; box-shadow: 0 8px 16px rgba(0,0,0,0.15); border-radius: 0 0 8px 8px; }
        .suggestion-item { padding: 14px; border-bottom: 1px solid #f1f1f1; cursor: pointer; }
        .suggestion-item:hover { background: #e0f2f1; color: var(--primary); font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95rem; background: white; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: center; }
        th { background: var(--primary); color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-right:10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h3 style="text-align:center; margin:10px 0 20px 0; color:var(--primary)">â˜ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</h3>

    <div class="nav-tabs">
        <div id="tab-import" class="nav-item active" onclick="switchTab('import')">1. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        <div id="tab-dispense" class="nav-item" onclick="switchTab('dispense')">2. Ø§Ù„ØµØ±Ù</div>
        <div id="tab-report" class="nav-item" onclick="switchTab('report')">3. Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    </div>

    <div id="import" class="section active">
        <div style="background:#e0f2f1; padding:20px; border-radius:10px; text-align:center; border: 1px dashed var(--primary);">
            <h4 style="margin-top:0; color:var(--primary)">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</h4>
            
            <div id="autoLoadStatus" style="margin-bottom:15px; font-weight:bold; color:#555;">
                Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù…Ù† GitHub...
            </div>

            <button class="btn-import" onclick="fetchExcelFromGitHub()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹</button>
            
            <hr style="margin:20px 0; border-color:#b2dfdb;">
            
            <p style="font-size:0.9rem;">Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹ (Excel / Backup):</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv, .json" style="display:block; margin:0 auto 10px auto;">
            <button class="btn-save" onclick="processManualFile()">ğŸ“‚ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙŠØ¯ÙˆÙŠ</button>
        </div>

        <div class="debug-console" id="logsContent">> System Initialization...</div>
        <button class="btn-reset" onclick="clearSystem()">âš ï¸ ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
    </div>

    <div id="dispense" class="section">
        <div class="form-group">
            <label>1. Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© (Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹):</label>
            <input type="text" id="dispenseSearch" onkeyup="handleSearch(this.value, 'dispense')" placeholder="Ø§ÙƒØªØ¨ 3 Ø£Ø­Ø±Ù..." autocomplete="off">
            <div class="suggestions-list" id="dispenseList"></div>
            <input type="hidden" id="dispenseItemHidden">
        </div>

        <div class="form-group">
            <label>2. Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù…ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø±ØµÙŠØ¯):</label>
            <select id="dispenseInst" onchange="checkDispenseBal()" disabled>
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© --</option>
            </select>
        </div>

        <div id="balBox" class="balance-box">
            Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="balNum" class="balance-num">0</span>
        </div>

        <div class="form-group">
            <label>3. Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
            <input type="number" id="qtyInput" placeholder="Ø§Ù„Ø¹Ø¯Ø¯">
        </div>
        <button class="btn-save" onclick="doDispense()">âœ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØµØ±Ù</button>
    </div>

    <div id="report" class="section">
        <div style="background: #f3e5f5; padding: 20px; border-radius: 10px;">
            <div class="form-group">
                <input type="text" id="reportSearch" onkeyup="handleSearch(this.value, 'report')" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯ÙˆØ§Ø¡..." autocomplete="off">
                <div class="suggestions-list" id="reportList"></div>
                <input type="hidden" id="reportItemHidden">
            </div>
            <button class="btn-import" style="background:#7b1fa2" onclick="generateReport()">Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
        </div>
        
        <div style="overflow-x:auto; margin-top:10px;">
            <table id="reportTable">
                <thead><tr><th>Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬</th><th>Ø§Ù„Ù…ØµØ±ÙˆÙ</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th></tr></thead>
                <tbody id="reportBody"><tr><td colspan="5" style="padding:20px;">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‡Ù†Ø§</td></tr></tbody>
            </table>
        </div>
        <hr>
        <button class="btn-backup" onclick="exportBackup()">ğŸ’¾ Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Backup)</button>
    </div>
</div>

<script>
    // ============================================================
    // âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ (Ø¶Ø¹ Ø±Ø§Ø¨Ø·Ùƒ Ù‡Ù†Ø§)
    // ============================================================
    
    // Ù…Ø«Ø§Ù„: "https://raw.githubusercontent.com/USERNAME/REPO/main/data2026.xlsx"
    const EXCEL_URL = "https://raw.githubusercontent.com/kingkopra00/calc-Medicine-/main/data2026.xlsx"; 
    
    // ============================================================

    function log(msg) {
        const box = document.getElementById('logsContent');
        box.innerHTML += `<div>> ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    let db = [];
    let uniqueItems = [];

    window.onload = function() {
        log("App Started.");
        loadDB(); // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ
        
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø­Ø§ÙˆÙ„ Ø³Ø­Ø¨ Ø§Ù„Ø¥ÙƒØ³Ù„ Ù…Ù† Ø§Ù„Ù†Øª
        if(db.length === 0) {
            fetchExcelFromGitHub();
        } else {
            document.getElementById('autoLoadStatus').innerHTML = `âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø© (${db.length} Ø³Ø¬Ù„).`;
        }
    };

    function switchTab(id) {
        document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const btn = document.getElementById('tab-' + id);
        if(btn) btn.classList.add('active');
    }

    // --- â˜ï¸ AUTO FETCH FROM GITHUB ---
    async function fetchExcelFromGitHub() {
        const statusDiv = document.getElementById('autoLoadStatus');
        statusDiv.innerHTML = '<span class="loader"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub...';
        log(`Connecting to: ${EXCEL_URL}`);

        try {
            const response = await fetch(EXCEL_URL);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            
            const arrayBuffer = await response.arrayBuffer();
            log("File downloaded. Parsing...");
            
            const workbook = XLSX.read(arrayBuffer, {type: 'array'});
            processWorkbook(workbook);
            
            statusDiv.innerHTML = `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (${db.length} Ø³Ø¬Ù„).`;
            alert("ØªÙ… Ø³Ø­Ø¨ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù…Ù† GitHub Ø¨Ù†Ø¬Ø§Ø­!");
            switchTab('dispense');

        } catch (err) {
            log(`Fetch Error: ${err.message}`);
            statusDiv.innerHTML = `âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ${err.message}. <br>ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±ÙØ¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ.`;
        }
    }

    // --- ğŸ“‚ MANUAL FILE UPLOAD ---
    function processManualFile() {
        const f = document.getElementById('fileInput').files[0];
        if(!f) return log("Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹.");
        
        if(f.name.endsWith('.json')) {
            // Restore Backup
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    db = JSON.parse(e.target.result);
                    saveDB();
                    log(`Restored backup: ${db.length} records.`);
                    alert("ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©!");
                    switchTab('dispense');
                } catch(err) { alert("Ù…Ù„Ù Ù…Ø¹Ø·ÙˆØ¨"); }
            };
            reader.readAsText(f);
        } else {
            // Manual Excel
            const reader = new FileReader();
            reader.onload = e => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                processWorkbook(workbook);
                alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥ÙƒØ³Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ!");
                switchTab('dispense');
            };
            reader.readAsArrayBuffer(f);
        }
    }

    // --- ğŸ§  CORE PARSING LOGIC (Shared) ---
    function processWorkbook(workbook) {
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
        
        let headerIdx = -1, instCols = [];
        
        // Find Header
        for(let i=0; i<Math.min(rows.length, 50); i++) {
            const str = JSON.stringify(rows[i]);
            if(str.includes("Ù…Ø³ØªØ´ÙÙ‰") || str.includes("Ù‚Ø·Ø§Ø¹")) {
                headerIdx = i;
                rows[i].forEach((cell, idx) => {
                    if(typeof cell === 'string' && (cell.includes("Ù…Ø³ØªØ´ÙÙ‰") || cell.includes("Ù‚Ø·Ø§Ø¹") || cell.includes("Ù…Ø±ÙƒØ²"))) {
                        instCols.push({name: cell.trim(), idx: idx});
                    }
                });
                break;
            }
        }

        if(headerIdx === -1) return log("Header not found in Excel!");

        // Parse
        let newDB = [], count = 0;
        for(let i=headerIdx+1; i<rows.length; i++) {
            const row = rows[i];
            if(!row || !row[0]) continue;
            
            const item = String(row[0]).trim();
            if(item.length < 2 || item.includes("SYSTEM")) continue;

            instCols.forEach(inst => {
                let val = row[inst.idx];
                let quota = typeof val === 'number' ? val : parseInt(String(val).replace(/[^0-9]/g, '')) || 0;
                
                if(quota > 0) {
                    newDB.push({inst: inst.name, item: item, quota: quota, used: 0});
                    count++;
                }
            });
        }
        
        db = newDB;
        saveDB();
        log(`Processed ${count} records successfully.`);
    }

    // --- ğŸ” SEARCH & FILTER ---
    function handleSearch(txt, type) {
        const listId = type === 'dispense' ? 'dispenseList' : 'reportList';
        const list = document.getElementById(listId);
        if(txt.length < 3) { list.style.display = 'none'; return; }

        const matches = uniqueItems.filter(i => i.toLowerCase().includes(txt.toLowerCase())).slice(0, 20);
        list.innerHTML = '';
        if(matches.length > 0) {
            list.style.display = 'block';
            matches.forEach(m => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = m;
                div.onclick = () => selectItem(m, type);
                list.appendChild(div);
            });
        } else { list.style.display = 'none'; }
    }

    function selectItem(name, type) {
        if(type === 'dispense') {
            document.getElementById('dispenseSearch').value = name;
            document.getElementById('dispenseItemHidden').value = name;
            document.getElementById('dispenseList').style.display = 'none';
            filterInstitutions(name);
        } else {
            document.getElementById('reportSearch').value = name;
            document.getElementById('reportItemHidden').value = name;
            document.getElementById('reportList').style.display = 'none';
        }
    }

    function filterInstitutions(itemName) {
        const sel = document.getElementById('dispenseInst');
        sel.disabled = false;
        document.getElementById('balBox').style.display = 'none';
        
        const valid = db.filter(r => r.item === itemName);
        sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¤Ø³Ø³Ø© --</option>';
        
        if(valid.length === 0) {
            sel.innerHTML = '<option>ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­ØµØ©</option>';
            sel.disabled = true;
            return;
        }
        valid.sort((a, b) => a.inst.localeCompare(b.inst));
        valid.forEach(r => sel.add(new Option(r.inst, r.inst)));
    }

    // --- ğŸ’Š DISPENSE ---
    function checkDispenseBal() {
        const inst = document.getElementById('dispenseInst').value;
        const item = document.getElementById('dispenseItemHidden').value;
        if(inst && item) {
            const rec = db.find(x => x.inst === inst && x.item === item);
            document.getElementById('balBox').style.display = 'block';
            document.getElementById('balNum').innerText = rec.quota - rec.used;
        }
    }

    function doDispense() {
        const inst = document.getElementById('dispenseInst').value;
        const item = document.getElementById('dispenseItemHidden').value;
        const qty = parseInt(document.getElementById('qtyInput').value);

        if(!inst || !item || !qty) return alert("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
        const rec = db.find(x => x.inst === inst && x.item === item);
        
        if(qty > (rec.quota - rec.used)) return alert("Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ!");
        
        rec.used += qty;
        saveDB();
        alert("ØªÙ… Ø§Ù„ØµØ±Ù âœ…");
        document.getElementById('qtyInput').value = '';
        checkDispenseBal();
    }

    // --- ğŸ“Š REPORT ---
    function generateReport() {
        const item = document.getElementById('reportItemHidden').value;
        const tbody = document.getElementById('reportBody');
        if(!item) return alert("Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø©");
        
        let data = db.filter(r => r.item === item);
        data.sort((a, b) => a.inst.localeCompare(b.inst));
        
        tbody.innerHTML = '';
        let tQ=0, tU=0;
        data.forEach(r => {
            tQ+=r.quota; tU+=r.used;
            tbody.innerHTML += `<tr><td>${r.inst}</td><td>${r.item}</td><td>${r.quota}</td><td>${r.used}</td><td style="color:${(r.quota-r.used)<=0?'red':'green'}">${r.quota-r.used}</td></tr>`;
        });
        tbody.innerHTML += `<tr style="background:#333; color:#fff"><td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td><td>--</td><td>${tQ}</td><td>${tU}</td><td>${tQ-tU}</td></tr>`;
    }

    function exportBackup() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], {type: "application/json"}));
        a.download = `Pharma_Backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    // --- ğŸ’¾ STORAGE ---
    function saveDB() {
        localStorage.setItem('pharma_cloud_v15', JSON.stringify(db));
        uniqueItems = [...new Set(db.map(r => r.item))].sort();
    }
    function loadDB() {
        const stored = localStorage.getItem('pharma_cloud_v15');
        if(stored) {
            db = JSON.parse(stored);
            uniqueItems = [...new Set(db.map(r => r.item))].sort();
        }
    }
    function clearSystem() {
        if(confirm("Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ")) { localStorage.removeItem('pharma_cloud_v15'); location.reload(); }
    }
</script>

</body>
</html>
